[gcode_macro M600]
gcode:
  {% set config = printer["gcode_macro _nb_config"] %}
  {% set extruder_temp = params.EXTRUDER|default(210)|float %}
  {% set speed = printer["gcode_macro _filament_temps"].speed %}
  {% set config = printer["gcode_macro _nb_config"] %}

  PAUSE

  SAVE_GCODE_STATE
  M117 Swapping filament...
  
  {% if printer.toolhead.position.z < config.service_z %}
    G90
    G0 Z{config.service_z} F10000
  {% else %}
    {action_respond_info("Skipping move to Z" + z|string + " because already at Z" + printer.toolhead.position.z|string)}
  {% endif %}
  TOOLHEAD_FRONT
  BEEP

  M117 Unloading...
  G1 E-100 F{speed}
  BEEP
  BEEP
  
  RESTORE_GCODE_STATE

[menu __main __swap_unload]
type: command
name: Swap Unload (again)
enable: {printer.idle_timeout.state != "Printing"}
gcode:
  {% set speed = printer["gcode_macro _filament_temps"].speed %}
  M117 Unloading...
  G1 E-100 F{speed}
  BEEP
  BEEP

[menu __main __swap]
type: command
name: Swap Filament
enable: {printer.idle_timeout.state != "Printing"}
gcode:
  {% set speed = printer["gcode_macro _filament_temps"].speed %}

  SAVE_GCODE_STATE
  BEEP

  M117 Loading...
  G1 E100 F{speed}
  G1 E20 F{speed}
  G1 E-0.5 F{speed} # retract a little to avoid oozing

  M117 Loaded
  BEEP
  BEEP
  RESTORE_GCODE_STATE
  {menu.exit()}

[menu __main __pause]
type: command
name: Pause
enable: {printer.idle_timeout.state == "Printing"}
gcode:
  PAUSE
  {menu.exit()}

[menu __main __resume]
type: command
name: Resume
enable: {printer.idle_timeout.state != "Printing"}
gcode:
  M117 Printing...
  RESUME
  {menu.exit()}
